<Window x:Class="IndiLogs_3._0.Views.ComparisonWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:IndiLogs_3._0.Controls"
        xmlns:components="clr-namespace:IndiLogs_3._0.ViewModels.Components"
        xmlns:converters="clr-namespace:IndiLogs_3._0.Converters"
        Title="Log Comparison"
        Height="800" Width="1400"
        MinHeight="400" MinWidth="800"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource BgDark}"
        ResizeMode="CanResizeWithGrip">

    <Window.Resources>
        <!-- Converters -->
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:DiffSegmentsConverter x:Key="DiffSegmentsConverter"/>

        <!-- Converter for source type display -->
        <DataTemplate x:Key="SourceTypeTemplate">
            <TextBlock Text="{Binding}"/>
        </DataTemplate>

        <!-- Style for the mask textbox -->
        <Style x:Key="MaskTextBoxStyle" TargetType="TextBox">
            <Setter Property="Background" Value="{DynamicResource BgCard}"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimary}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderColor}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsMaskValid}" Value="False">
                    <Setter Property="BorderBrush" Value="{DynamicResource DangerColor}"/>
                    <Setter Property="Foreground" Value="{DynamicResource DangerColor}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- Style for source type combo box -->
        <Style x:Key="SourceComboStyle" TargetType="ComboBox" BasedOn="{StaticResource {x:Type ComboBox}}">
            <Setter Property="MinWidth" Value="120"/>
            <Setter Property="Margin" Value="0,0,5,0"/>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Global Toolbar -->
            <RowDefinition Height="*"/>     <!-- Main Content -->
        </Grid.RowDefinitions>

        <!-- Global Toolbar -->
        <Border Grid.Row="0" Background="{DynamicResource BgPanel}" Padding="10" BorderThickness="0,0,0,1" BorderBrush="{DynamicResource BorderColor}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Left: Diff controls -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <CheckBox Content="Show Diffs"
                              IsChecked="{Binding ShowDiffs}"
                              Margin="0,0,10,0"
                              VerticalContentAlignment="Center"
                              Foreground="{DynamicResource TextPrimary}"
                              ToolTip="Toggle diff highlighting"/>
                </StackPanel>

                <!-- Center: Mask input -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center">
                    <TextBlock Text="Ignore Pattern:"
                               VerticalAlignment="Center"
                               Foreground="{DynamicResource TextSecondary}"
                               Margin="0,0,8,0"/>
                    <TextBox Width="250"
                             Text="{Binding IgnoreMaskPattern, UpdateSourceTrigger=PropertyChanged, Delay=300}"
                             Style="{StaticResource MaskTextBoxStyle}">
                        <TextBox.ToolTip>
                            <ToolTip MaxWidth="400">
                                <StackPanel>
                                    <TextBlock Text="Ignore Pattern (Regex)" FontWeight="Bold" Margin="0,0,0,5"/>
                                    <TextBlock TextWrapping="Wrap" Text="Enter a regular expression pattern to ignore during comparison. Matched content will be replaced with '#' before comparing."/>
                                    <TextBlock Text="Examples:" FontWeight="SemiBold" Margin="0,8,0,3"/>
                                    <TextBlock Text="• \d+ → Ignore all numbers" Margin="10,0,0,2"/>
                                    <TextBlock Text="• [a-f0-9\-]{36} → Ignore GUIDs" Margin="10,0,0,2"/>
                                    <TextBlock Text="• \d{2}:\d{2}:\d{2} → Ignore time stamps (HH:mm:ss)" Margin="10,0,0,2"/>
                                    <TextBlock Text="• 0x[0-9a-fA-F]+ → Ignore hex addresses" Margin="10,0,0,2"/>
                                    <TextBlock Text="• \[.*?\] → Ignore content in brackets" Margin="10,0,0,2"/>
                                    <TextBlock Text="• (foo|bar|baz) → Ignore specific words" Margin="10,0,0,2"/>
                                    <TextBlock Text="Tip:" FontWeight="SemiBold" Margin="0,8,0,3"/>
                                    <TextBlock TextWrapping="Wrap" Text="Combine patterns with | (OR): \d+|[a-f0-9\-]{36}"/>
                                    <TextBlock TextWrapping="Wrap" Text="Red border indicates invalid regex pattern." Foreground="#EF4444" Margin="0,5,0,0"/>
                                </StackPanel>
                            </ToolTip>
                        </TextBox.ToolTip>
                    </TextBox>
                    <Button Content="?"
                            FontWeight="Bold"
                            FontSize="12"
                            Width="22"
                            Height="22"
                            Padding="0"
                            Margin="5,0,0,0"
                            Background="{DynamicResource BgCard}"
                            Foreground="{DynamicResource PrimaryColor}"
                            BorderBrush="{DynamicResource PrimaryColor}"
                            BorderThickness="1"
                            Cursor="Help"
                            Click="HelpButton_Click">
                        <Button.ToolTip>
                            <ToolTip MaxWidth="400">
                                <StackPanel>
                                    <TextBlock Text="Ignore Pattern Help" FontWeight="Bold" Margin="0,0,0,5"/>
                                    <TextBlock TextWrapping="Wrap" Text="Use regex patterns to ignore dynamic content when comparing logs. This is useful for comparing logs that differ only in timestamps, IDs, or other variable data."/>
                                    <TextBlock Text="Common Patterns:" FontWeight="SemiBold" Margin="0,8,0,3"/>
                                    <TextBlock Text="• \d+ → Numbers (e.g., 123, 45678)" Margin="10,0,0,2"/>
                                    <TextBlock Text="• [a-f0-9\-]{36} → GUIDs" Margin="10,0,0,2"/>
                                    <TextBlock Text="• \d{2}:\d{2}:\d{2}(\.\d+)? → Time (HH:mm:ss.fff)" Margin="10,0,0,2"/>
                                    <TextBlock Text="• \d{4}-\d{2}-\d{2} → Date (YYYY-MM-DD)" Margin="10,0,0,2"/>
                                    <TextBlock Text="• 0x[0-9a-fA-F]+ → Hex addresses" Margin="10,0,0,2"/>
                                    <TextBlock Text="• \[.*?\] → Bracketed content" Margin="10,0,0,2"/>
                                    <TextBlock Text="• Thread-\d+ → Thread names" Margin="10,0,0,2"/>
                                    <TextBlock Text="" Margin="0,5,0,0"/>
                                    <TextBlock Text="Click for more info" FontStyle="Italic" Foreground="Gray"/>
                                </StackPanel>
                            </ToolTip>
                        </Button.ToolTip>
                    </Button>
                </StackPanel>

                <!-- Right: Sync toggle and Debug -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <CheckBox IsChecked="{Binding IsSyncLocked}"
                              VerticalContentAlignment="Center"
                              Foreground="{DynamicResource TextPrimary}"
                              ToolTip="Synchronize scrolling between panes"
                              Margin="0,0,15,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Sync " VerticalAlignment="Center"/>
                            <TextBlock Text="ON" Foreground="{DynamicResource SuccessColor}" VerticalAlignment="Center"
                                       Visibility="{Binding IsSyncLocked, Converter={StaticResource BoolToVisibility}}"/>
                            <TextBlock Text="OFF" Foreground="{DynamicResource TextSecondary}" VerticalAlignment="Center"
                                       Visibility="{Binding IsSyncLocked, Converter={StaticResource BoolToVisibility}, ConverterParameter=Inverse}"/>
                        </StackPanel>
                    </CheckBox>
                    <CheckBox x:Name="DebugCheckBox"
                              Content="Debug"
                              VerticalContentAlignment="Center"
                              Foreground="{DynamicResource TextSecondary}"
                              ToolTip="Enable debug logging to file"
                              Checked="DebugCheckBox_Checked"
                              Unchecked="DebugCheckBox_Unchecked"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Split View -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="70"/>  <!-- Delta Column -->
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Pane -->
            <Grid Grid.Column="0" DataContext="{Binding LeftPane}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>  <!-- Source Selector -->
                    <RowDefinition Height="*"/>     <!-- Grid -->
                </Grid.RowDefinitions>

                <!-- Source Selector -->
                <Border Grid.Row="0" Background="{DynamicResource BgCard}" Padding="8" BorderThickness="0,0,0,1" BorderBrush="{DynamicResource BorderColor}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <ComboBox Grid.Column="0"
                                  ItemsSource="{Binding SourceTypes}"
                                  SelectedItem="{Binding SelectedSourceType}"
                                  Style="{StaticResource SourceComboStyle}"/>

                        <ComboBox Grid.Column="1"
                                  ItemsSource="{Binding AvailableFilters}"
                                  SelectedItem="{Binding SelectedFilter}"
                                  Style="{StaticResource SourceComboStyle}"
                                  Visibility="{Binding ShowFilterDropdown, Converter={StaticResource BoolToVisibility}}"/>

                        <TextBox Grid.Column="2"
                                 Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged, Delay=300}"
                                 Background="{DynamicResource BgPanel}"
                                 Foreground="{DynamicResource TextPrimary}"
                                 BorderThickness="1"
                                 BorderBrush="{DynamicResource BorderColor}"
                                 Padding="8,4"
                                 Margin="10,0,0,0"
                                 ToolTip="Search within this pane"/>
                    </Grid>
                </Border>

                <!-- DataGrid -->
                <DataGrid x:Name="LeftDataGrid" Grid.Row="1"
                          ItemsSource="{Binding FilteredLogs}"
                          SelectedItem="{Binding SelectedLog, Mode=TwoWay}"
                          Background="Transparent"
                          BorderThickness="0"
                          Foreground="{DynamicResource TextPrimary}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          RowStyle="{DynamicResource LogRowStyle}"
                          SelectionMode="Extended"
                          SelectionUnit="FullRow"
                          VirtualizingPanel.IsVirtualizing="True"
                          VirtualizingPanel.VirtualizationMode="Recycling"
                          EnableRowVirtualization="True"
                          ScrollViewer.ScrollChanged="LeftGrid_ScrollChanged"
                          MouseDoubleClick="DataGrid_MouseDoubleClick"
                          PreviewKeyDown="DataGrid_PreviewKeyDown">

                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Time"
                                            Binding="{Binding Date, StringFormat='HH:mm:ss.fff'}"
                                            Width="100"
                                            FontWeight="Bold"/>

                        <DataGridTextColumn Header="Lvl"
                                            Binding="{Binding Level}"
                                            Width="50"/>

                        <DataGridTextColumn Header="Thread"
                                            Binding="{Binding ThreadName}"
                                            Width="100">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{DynamicResource PrimaryColor}"/>
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <DataGridTemplateColumn Header="Message" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <controls:DiffHighlightTextBlock
                                        PlainText="{Binding Message}"
                                        ShowDiffs="{Binding DataContext.ShowDiffs, RelativeSource={RelativeSource AncestorType=Window}}"
                                        TextTrimming="CharacterEllipsis"
                                        VerticalAlignment="Center">
                                        <controls:DiffHighlightTextBlock.DiffSegments>
                                            <MultiBinding Converter="{StaticResource DiffSegmentsConverter}">
                                                <Binding/>
                                                <Binding Path="DataContext" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                                <Binding Source="Left"/>
                                                <Binding Path="DataContext.DiffVersion" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                            </MultiBinding>
                                        </controls:DiffHighlightTextBlock.DiffSegments>
                                    </controls:DiffHighlightTextBlock>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>

            <!-- Center Delta Column -->
            <Border Grid.Column="1" Background="{DynamicResource BgCard}" BorderThickness="1,0" BorderBrush="{DynamicResource BorderColor}">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <TextBlock Text="Delta"
                               FontSize="12"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource TextSecondary}"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,5"/>
                    <TextBlock Text="{Binding DeltaDisplay}"
                               Foreground="{Binding DeltaColor}"
                               FontWeight="Bold"
                               FontSize="16"
                               HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>

            <!-- Right Pane -->
            <Grid Grid.Column="2" DataContext="{Binding RightPane}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>  <!-- Source Selector -->
                    <RowDefinition Height="*"/>     <!-- Grid -->
                </Grid.RowDefinitions>

                <!-- Source Selector -->
                <Border Grid.Row="0" Background="{DynamicResource BgCard}" Padding="8" BorderThickness="0,0,0,1" BorderBrush="{DynamicResource BorderColor}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <ComboBox Grid.Column="0"
                                  ItemsSource="{Binding SourceTypes}"
                                  SelectedItem="{Binding SelectedSourceType}"
                                  Style="{StaticResource SourceComboStyle}"/>

                        <ComboBox Grid.Column="1"
                                  ItemsSource="{Binding AvailableFilters}"
                                  SelectedItem="{Binding SelectedFilter}"
                                  Style="{StaticResource SourceComboStyle}"
                                  Visibility="{Binding ShowFilterDropdown, Converter={StaticResource BoolToVisibility}}"/>

                        <TextBox Grid.Column="2"
                                 Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged, Delay=300}"
                                 Background="{DynamicResource BgPanel}"
                                 Foreground="{DynamicResource TextPrimary}"
                                 BorderThickness="1"
                                 BorderBrush="{DynamicResource BorderColor}"
                                 Padding="8,4"
                                 Margin="10,0,0,0"
                                 ToolTip="Search within this pane"/>
                    </Grid>
                </Border>

                <!-- DataGrid -->
                <DataGrid x:Name="RightDataGrid" Grid.Row="1"
                          ItemsSource="{Binding FilteredLogs}"
                          SelectedItem="{Binding SelectedLog, Mode=TwoWay}"
                          Background="Transparent"
                          BorderThickness="0"
                          Foreground="{DynamicResource TextPrimary}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          RowStyle="{DynamicResource LogRowStyle}"
                          SelectionMode="Extended"
                          SelectionUnit="FullRow"
                          VirtualizingPanel.IsVirtualizing="True"
                          VirtualizingPanel.VirtualizationMode="Recycling"
                          EnableRowVirtualization="True"
                          ScrollViewer.ScrollChanged="RightGrid_ScrollChanged"
                          MouseDoubleClick="DataGrid_MouseDoubleClick"
                          PreviewKeyDown="DataGrid_PreviewKeyDown">

                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Time"
                                            Binding="{Binding Date, StringFormat='HH:mm:ss.fff'}"
                                            Width="100"
                                            FontWeight="Bold"/>

                        <DataGridTextColumn Header="Lvl"
                                            Binding="{Binding Level}"
                                            Width="50"/>

                        <DataGridTextColumn Header="Thread"
                                            Binding="{Binding ThreadName}"
                                            Width="100">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{DynamicResource PrimaryColor}"/>
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <DataGridTemplateColumn Header="Message" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <controls:DiffHighlightTextBlock
                                        PlainText="{Binding Message}"
                                        ShowDiffs="{Binding DataContext.ShowDiffs, RelativeSource={RelativeSource AncestorType=Window}}"
                                        TextTrimming="CharacterEllipsis"
                                        VerticalAlignment="Center">
                                        <controls:DiffHighlightTextBlock.DiffSegments>
                                            <MultiBinding Converter="{StaticResource DiffSegmentsConverter}">
                                                <Binding/>
                                                <Binding Path="DataContext" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                                <Binding Source="Right"/>
                                                <Binding Path="DataContext.DiffVersion" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                            </MultiBinding>
                                        </controls:DiffHighlightTextBlock.DiffSegments>
                                    </controls:DiffHighlightTextBlock>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Grid>
    </Grid>
</Window>
